<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic/Story Generator - Granular Approval Workflow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        /* Progress Stepper */
        .stepper {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stepper-items {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stepper-item {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .stepper-item:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 25px;
            left: 60%;
            right: -40%;
            height: 3px;
            background: #e0e0e0;
            z-index: 0;
        }

        .stepper-item.active:not(:last-child)::after,
        .stepper-item.completed:not(:last-child)::after {
            background: #667eea;
        }

        .stepper-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
            margin-bottom: 8px;
        }

        .stepper-item.active .stepper-circle {
            background: #667eea;
            color: white;
        }

        .stepper-item.completed .stepper-circle {
            background: #28a745;
            color: white;
        }

        .stepper-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .stepper-item.active .stepper-label {
            color: #667eea;
            font-weight: 600;
        }

        /* Screen Container */
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 500px;
        }

        .screen {
            display: none;
            padding: 40px;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Screen 1: Input */
        .input-label {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        #descriptionInput {
            width: 100%;
            padding: 20px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            resize: vertical;
            min-height: 200px;
            transition: border-color 0.3s;
            font-family: inherit;
            margin-bottom: 20px;
        }

        #descriptionInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-success:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* Epic Container */
        .epic-container {
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .epic-container.approved {
            border-color: #28a745;
            background: #f0fff4;
        }

        .epic-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .epic-container.approved .epic-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .epic-title {
            font-size: 1.3rem;
            font-weight: 600;
            flex: 1;
        }

        .epic-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .epic-container.expanded .epic-toggle {
            transform: rotate(180deg);
        }

        .epic-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .epic-container.expanded .epic-content {
            max-height: 10000px;
        }

        .epic-body {
            padding: 25px;
            background: #f8f9fa;
        }

        .epic-description {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            line-height: 1.6;
        }

        /* User Story */
        .user-story {
            background: white;
            border: 2px solid #e0e0e0;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
        }

        .user-story.approved {
            border-color: #28a745;
            background: #f0fff4;
        }

        .story-header {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .story-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        /* Test Case */
        .test-case {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            position: relative;
        }

        .test-case.approved {
            border-color: #28a745;
            background: #f0fff8;
        }

        .test-case-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-case-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Acceptance Criteria */
        .acceptance-criteria {
            margin-top: 15px;
            padding: 12px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            position: relative;
        }

        .acceptance-criteria.approved {
            border-color: #28a745;
            background: #e8f5e9;
        }

        .ac-header {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ac-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: #28a745;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Screen 3: Approved */
        .approved-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .approved-summary h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .complete-output {
            background: #f5f5f5;
            padding: 25px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.6;
            overflow-x: auto;
            border: 2px solid #e0e0e0;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #f00;
            padding: 20px;
            border-radius: 8px;
            color: #c00;
            margin: 20px 0;
        }

        .navigation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: space-between;
        }

        .epic-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .screen {
                padding: 20px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .stepper-items {
                font-size: 0.85rem;
            }

            .stepper-circle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .story-actions,
            .test-case-actions,
            .ac-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Epic/Story Generator</h1>
            <p>Granular Approval Workflow - Review & Approve Each Component</p>
        </div>

        <!-- Progress Stepper -->
        <div class="stepper">
            <div class="stepper-items">
                <div class="stepper-item active" id="step1">
                    <div class="stepper-circle">1</div>
                    <div class="stepper-label">Input Description</div>
                </div>
                <div class="stepper-item" id="step2">
                    <div class="stepper-circle">2</div>
                    <div class="stepper-label">Review & Approve</div>
                </div>
                <div class="stepper-item" id="step3">
                    <div class="stepper-circle">3</div>
                    <div class="stepper-label">Approved Documentation</div>
                </div>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="main-card">
            <!-- Screen 1: Input Description -->
            <div id="screen1" class="screen active">
                <label for="descriptionInput" class="input-label">
                    üìù Enter Your Project Description
                </label>
                <textarea
                    id="descriptionInput"
                    placeholder="Example: Build a comprehensive health and fitness tracking mobile application with user authentication, workout logging, nutrition tracking, progress analytics, social features, and integration with wearable devices..."
                ></textarea>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="clearInput()">
                        üóëÔ∏è Clear
                    </button>
                    <button class="btn btn-primary" id="generateBtn" onclick="generateDocumentation()">
                        ‚ú® Generate Epics
                    </button>
                </div>
            </div>

            <!-- Screen 2: Review Epics -->
            <div id="screen2" class="screen">
                <h2 style="margin-bottom: 10px; color: #333;">üìã Review & Approve Components</h2>
                <p style="margin-bottom: 30px; color: #666;">Review each epic, user story, test case, and acceptance criteria. Approve only what you need.</p>

                <div id="epicsContainer">
                    <!-- Epics will be dynamically loaded here -->
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="goToScreen(1)">
                        ‚Üê Back to Input
                    </button>
                    <button class="btn btn-success" id="viewApprovedBtn" onclick="goToScreen(3)">
                        View Approved Documentation ‚Üí
                    </button>
                </div>
            </div>

            <!-- Screen 3: Approved Documentation -->
            <div id="screen3" class="screen">
                <div class="approved-summary">
                    <h2>‚úÖ Approved Project Documentation</h2>
                    <p id="approvedCount">Loading...</p>
                </div>

                <div id="approvedEpicsContainer">
                    <!-- Approved epics will be displayed here -->
                </div>

                <h3 style="margin: 30px 0 15px 0; color: #333;">üìÑ Complete Output</h3>
                <div id="completeOutput" class="complete-output">
                    <!-- Complete formatted output will be shown here -->
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="goToScreen(2)">
                        ‚Üê Back to Review
                    </button>
                    <button class="btn btn-primary" onclick="startNew()">
                        üîÑ Start New Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let allEpics = [];
        let projectDescription = '';
        let generatorUsed = '';

        // Screen navigation
        function goToScreen(screenNumber) {
            // Update stepper
            document.querySelectorAll('.stepper-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index + 1 < screenNumber) {
                    item.classList.add('completed');
                } else if (index + 1 === screenNumber) {
                    item.classList.add('active');
                }
            });

            // Update screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(`screen${screenNumber}`).classList.add('active');

            // Update screen 3 if navigating there
            if (screenNumber === 3) {
                updateApprovedScreen();
            }
        }

        // Generate documentation
        async function generateDocumentation() {
            const description = document.getElementById('descriptionInput').value.trim();

            if (!description) {
                alert('Please enter a project description');
                return;
            }

            projectDescription = description;
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '‚è≥ Generating...';

            // Show screen 2 with loading
            goToScreen(2);
            document.getElementById('epicsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>AI is generating comprehensive documentation with 5 epics...</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">This may take 30-60 seconds</p>
                </div>
            `;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                const data = await response.json();

                if (data.success) {
                    allEpics = data.result.epics.map(epic => ({
                        ...epic,
                        approved: false,
                        expanded: false,
                        user_stories: epic.user_stories.map(story => ({
                            ...story,
                            approved: false,
                            ac_approved: false,
                            test_cases: story.test_cases?.map(tc => ({
                                ...tc,
                                approved: false
                            })) || []
                        }))
                    }));
                    generatorUsed = data.generator_used || 'AI Generator';
                    displayEpicsForReview();
                } else {
                    showError(data.error || 'Generation failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '‚ú® Generate Epics';
            }
        }

        // Display epics for review
        function displayEpicsForReview() {
            const container = document.getElementById('epicsContainer');

            const html = allEpics.map((epic, eIndex) => {
                const userStoriesHtml = epic.user_stories.map((story, sIndex) => {
                    const testCasesHtml = story.test_cases?.map((tc, tcIndex) => `
                        <div class="test-case ${tc.approved ? 'approved' : ''}" id="tc-${eIndex}-${sIndex}-${tcIndex}">
                            <div class="test-case-title">
                                <span>
                                    üß™ Test Case <span class="badge">${escapeHtml(tc.test_case_id)}</span>
                                    ${tc.approved ? '<span class="badge badge-success">‚úì</span>' : ''}
                                </span>
                            </div>
                            <div><strong>Description:</strong> ${escapeHtml(tc.test_case_description)}</div>
                            ${tc.expected_results?.length > 0 ? `
                                <div style="margin-top: 10px;"><strong>Expected Results:</strong></div>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    ${tc.expected_results.map(result => `<li>${escapeHtml(result)}</li>`).join('')}
                                </ul>
                            ` : ''}
                            <div class="test-case-actions">
                                <button class="btn btn-success btn-small" onclick="approveTestCase(${eIndex}, ${sIndex}, ${tcIndex})" ${tc.approved ? 'disabled' : ''}>
                                    ${tc.approved ? '‚úì Approved' : '‚úì Approve'}
                                </button>
                                <button class="btn btn-danger btn-small" onclick="cancelTestCase(${eIndex}, ${sIndex}, ${tcIndex})">
                                    ‚úï Cancel
                                </button>
                            </div>
                        </div>
                    `).join('') || '';

                    return `
                        <div class="user-story ${story.approved ? 'approved' : ''}" id="story-${eIndex}-${sIndex}">
                            <div class="story-header">
                                <span>
                                    üë§ User Story <span class="badge">${escapeHtml(story.story_id)}</span>
                                    ${story.story_points ? `<span class="badge badge-warning">${escapeHtml(story.story_points)} pts</span>` : ''}
                                    ${story.approved ? '<span class="badge badge-success">‚úì Approved</span>' : ''}
                                </span>
                            </div>
                            <div><strong>${escapeHtml(story.story_title)}</strong></div>
                            <div style="margin-top: 10px;">${escapeHtml(story.story_description)}</div>

                            ${story.acceptance_criteria ? `
                                <div class="acceptance-criteria ${story.ac_approved ? 'approved' : ''}" id="ac-${eIndex}-${sIndex}">
                                    <div class="ac-header">
                                        <span>
                                            <strong>‚úÖ Acceptance Criteria</strong>
                                            ${story.ac_approved ? '<span class="badge badge-success">‚úì</span>' : ''}
                                        </span>
                                    </div>
                                    <div style="margin-top: 8px;">${escapeHtml(story.acceptance_criteria)}</div>
                                    <div class="ac-actions">
                                        <button class="btn btn-success btn-small" onclick="approveAC(${eIndex}, ${sIndex})" ${story.ac_approved ? 'disabled' : ''}>
                                            ${story.ac_approved ? '‚úì Approved' : '‚úì Approve'}
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="cancelAC(${eIndex}, ${sIndex})">
                                            ‚úï Cancel
                                        </button>
                                    </div>
                                </div>
                            ` : ''}

                            ${testCasesHtml}

                            <div class="story-actions">
                                <button class="btn btn-success btn-small" onclick="approveStory(${eIndex}, ${sIndex})" ${story.approved ? 'disabled' : ''}>
                                    ${story.approved ? '‚úì Approved' : '‚úì Approve Story'}
                                </button>
                                <button class="btn btn-danger btn-small" onclick="cancelStory(${eIndex}, ${sIndex})">
                                    ‚úï Cancel Story
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="epic-container ${epic.expanded ? 'expanded' : ''} ${epic.approved ? 'approved' : ''}" id="epic-${eIndex}">
                        <div class="epic-header" onclick="toggleEpic(${eIndex})">
                            <div class="epic-title">
                                üéØ Epic <span class="badge">${escapeHtml(epic.epic_id)}</span>
                                ${epic.approved ? '<span class="badge badge-success">‚úì Approved</span>' : ''}
                                <div style="font-size: 0.9rem; font-weight: 400; margin-top: 5px;">${escapeHtml(epic.epic_title)}</div>
                            </div>
                            <div class="epic-toggle">‚ñº</div>
                        </div>
                        <div class="epic-content">
                            <div class="epic-body">
                                <div class="epic-description">
                                    <strong>Description:</strong><br>
                                    ${escapeHtml(epic.epic_description)}
                                </div>
                                ${userStoriesHtml}
                                <div class="epic-actions">
                                    <button class="btn btn-success" onclick="approveEpic(${eIndex})" ${epic.approved ? 'disabled' : ''}>
                                        ${epic.approved ? '‚úì Approved' : '‚úì Approve Epic'}
                                    </button>
                                    <button class="btn btn-danger" onclick="cancelEpic(${eIndex})">
                                        ‚úï Cancel Epic
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            updateApprovedButton();
        }

        // Toggle epic expansion
        function toggleEpic(eIndex) {
            allEpics[eIndex].expanded = !allEpics[eIndex].expanded;
            displayEpicsForReview();
        }

        // Approve epic (approves entire epic with all children)
        function approveEpic(eIndex) {
            allEpics[eIndex].approved = true;
            allEpics[eIndex].user_stories.forEach(story => {
                story.approved = true;
                story.ac_approved = true;
                story.test_cases?.forEach(tc => tc.approved = true);
            });
            displayEpicsForReview();
        }

        // Approve user story (and all its children)
        function approveStory(eIndex, sIndex) {
            const story = allEpics[eIndex].user_stories[sIndex];
            story.approved = true;
            story.ac_approved = true;
            story.test_cases?.forEach(tc => tc.approved = true);
            displayEpicsForReview();
        }

        // Approve acceptance criteria
        function approveAC(eIndex, sIndex) {
            allEpics[eIndex].user_stories[sIndex].ac_approved = true;
            displayEpicsForReview();
        }

        // Approve test case
        function approveTestCase(eIndex, sIndex, tcIndex) {
            allEpics[eIndex].user_stories[sIndex].test_cases[tcIndex].approved = true;
            displayEpicsForReview();
        }

        // Cancel functions
        function cancelEpic(eIndex) {
            if (!confirm('Remove this entire epic?')) return;
            allEpics.splice(eIndex, 1);
            displayEpicsForReview();
        }

        function cancelStory(eIndex, sIndex) {
            if (!confirm('Remove this user story?')) return;
            allEpics[eIndex].user_stories.splice(sIndex, 1);
            displayEpicsForReview();
        }

        function cancelAC(eIndex, sIndex) {
            if (!confirm('Remove acceptance criteria?')) return;
            allEpics[eIndex].user_stories[sIndex].acceptance_criteria = null;
            allEpics[eIndex].user_stories[sIndex].ac_approved = false;
            displayEpicsForReview();
        }

        function cancelTestCase(eIndex, sIndex, tcIndex) {
            if (!confirm('Remove this test case?')) return;
            allEpics[eIndex].user_stories[sIndex].test_cases.splice(tcIndex, 1);
            displayEpicsForReview();
        }

        // Update approved button
        function updateApprovedButton() {
            let approvedCount = 0;
            allEpics.forEach(epic => {
                epic.user_stories.forEach(story => {
                    if (story.approved) approvedCount++;
                    if (story.ac_approved) approvedCount++;
                    story.test_cases?.forEach(tc => {
                        if (tc.approved) approvedCount++;
                    });
                });
            });

            const btn = document.getElementById('viewApprovedBtn');
            btn.innerHTML = `View Approved Documentation (${approvedCount} items) ‚Üí`;
            btn.disabled = approvedCount === 0;
        }

        // Update approved screen
        function updateApprovedScreen() {
            let approvedStories = 0;
            let approvedACs = 0;
            let approvedTCs = 0;

            const approvedEpics = allEpics.filter(epic => {
                // Include epic if it has any approved components
                return epic.user_stories.some(story =>
                    story.approved || story.ac_approved || story.test_cases?.some(tc => tc.approved)
                );
            });

            // Display approved components
            const approvedHtml = approvedEpics.map(epic => {
                const approvedStoriesInEpic = epic.user_stories.filter(story => {
                    const hasApproved = story.approved || story.ac_approved || story.test_cases?.some(tc => tc.approved);
                    if (story.approved) approvedStories++;
                    if (story.ac_approved) approvedACs++;
                    story.test_cases?.forEach(tc => { if (tc.approved) approvedTCs++; });
                    return hasApproved;
                });

                if (approvedStoriesInEpic.length === 0) return '';

                const storiesHtml = approvedStoriesInEpic.map(story => {
                    const testCasesHtml = story.test_cases?.filter(tc => tc.approved).map(tc => `
                        <div class="test-case approved">
                            <div class="test-case-title">
                                üß™ Test Case <span class="badge">${escapeHtml(tc.test_case_id)}</span>
                                <span class="badge badge-success">‚úì</span>
                            </div>
                            <div><strong>Description:</strong> ${escapeHtml(tc.test_case_description)}</div>
                            ${tc.expected_results?.length > 0 ? `
                                <div style="margin-top: 10px;"><strong>Expected Results:</strong></div>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    ${tc.expected_results.map(result => `<li>${escapeHtml(result)}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('') || '';

                    return `
                        ${story.approved ? `
                            <div class="user-story approved">
                                <div class="story-header">
                                    üë§ User Story <span class="badge">${escapeHtml(story.story_id)}</span>
                                    <span class="badge badge-success">‚úì Approved</span>
                                </div>
                                <div><strong>${escapeHtml(story.story_title)}</strong></div>
                                <div style="margin-top: 10px;">${escapeHtml(story.story_description)}</div>

                                ${story.ac_approved && story.acceptance_criteria ? `
                                    <div class="acceptance-criteria approved">
                                        <div class="ac-header">
                                            <strong>‚úÖ Acceptance Criteria</strong>
                                            <span class="badge badge-success">‚úì</span>
                                        </div>
                                        <div style="margin-top: 8px;">${escapeHtml(story.acceptance_criteria)}</div>
                                    </div>
                                ` : ''}

                                ${testCasesHtml}
                            </div>
                        ` : ''}
                    `;
                }).join('');

                return `
                    <div class="epic-container approved" style="margin-bottom: 20px;">
                        <div class="epic-header">
                            <div class="epic-title">
                                üéØ Epic <span class="badge">${escapeHtml(epic.epic_id)}</span>
                                - ${escapeHtml(epic.epic_title)}
                            </div>
                        </div>
                        <div class="epic-content" style="max-height: none;">
                            <div class="epic-body">
                                <div class="epic-description">
                                    ${escapeHtml(epic.epic_description)}
                                </div>
                                ${storiesHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('approvedCount').textContent =
                `${approvedStories} User Stories, ${approvedACs} Acceptance Criteria, ${approvedTCs} Test Cases`;
            document.getElementById('approvedEpicsContainer').innerHTML = approvedHtml;

            // Generate complete output
            let completeOutput = `PROJECT: ${projectDescription}\n\nGENERATOR: ${generatorUsed}\n\n`;
            completeOutput += '='.repeat(80) + '\n\n';

            approvedEpics.forEach(epic => {
                completeOutput += `Epic ${epic.epic_id}: ${epic.epic_title}\n`;
                completeOutput += `Description: ${epic.epic_description}\n\n`;

                epic.user_stories.filter(s => s.approved).forEach(story => {
                    completeOutput += `User Story ${story.story_id}: ${story.story_title}\n`;
                    completeOutput += `Description: ${story.story_description}\n`;
                    if (story.story_points) {
                        completeOutput += `Story Points: ${story.story_points}\n`;
                    }
                    if (story.ac_approved && story.acceptance_criteria) {
                        completeOutput += `Acceptance Criteria: ${story.acceptance_criteria}\n`;
                    }
                    completeOutput += '\n';

                    story.test_cases?.filter(tc => tc.approved).forEach(tc => {
                        completeOutput += `Test Case ID: ${tc.test_case_id}\n`;
                        completeOutput += `Test Case Description: ${tc.test_case_description}\n`;
                        if (tc.expected_results?.length > 0) {
                            completeOutput += 'Expected Results:\n';
                            tc.expected_results.forEach((result, idx) => {
                                completeOutput += `${idx + 1}. ${result}\n`;
                            });
                        }
                        completeOutput += '\n';
                    });
                });

                completeOutput += '='.repeat(80) + '\n\n';
            });

            document.getElementById('completeOutput').textContent = completeOutput;
        }

        // Utility functions
        function clearInput() {
            document.getElementById('descriptionInput').value = '';
        }

        function startNew() {
            if (!confirm('Start a new project? This will clear all current data.')) return;
            allEpics = [];
            projectDescription = '';
            clearInput();
            goToScreen(1);
        }

        function showError(message) {
            document.getElementById('epicsContainer').innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${escapeHtml(message)}
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
